---
title: "Template"
author: "Tristan Verbeek, 2864049"
date: "`r Sys.Date()`"
output: pdf_document
---

# Set-up your environment

```{r package_install, include=FALSE}
install.packages("tidyverse")
install.packages("readxl")
install.packages("dplyr")
```

```{r packages}
library(tidyverse)
library(readxl)
library(dplyr)
```

# Title Page

Include your names

Include the tutorial group number

Include your tutorial lecturer's name

# Part 1 - Identify a Social Problem

Use APA referencing throughout your document. [Here's a link to some explanation.](https://www.mendeley.com/guides/apa-citation-guide/)

## 1.1 Describe the Social Problem

Include the following:

-   Why is this relevant?

-   ...

# Part 2 - Data Sourcing

## 2.1 Load in the data

Preferably from a URL, but if not, make sure to download the data and store it in a shared location that you can load the data in from. Do not store the data in a folder you include in the Github repository!

```{r}

# Load data on health spending  directly from Dropbox (public direct link)
url_spending <- "https://www.dropbox.com/scl/fi/01df0ly3ornjgcis9kwsk/CHE-per-region.csv?rlkey=nwvmxv33dc3uvp9pnil4tqimk&st=5zgoazd8&dl=1"

# Load data on health coverage  directly from Dropbox (public direct link)
url_coverage <- "https://www.dropbox.com/scl/fi/08rf7e6sj3hcq3e5fnp8l/datasetcoverage.xlsx?rlkey=x9iwcifdi2vmqa3j4oy1zs7p3&st=g5kdhaib&dl=1"

# Download het bestand tijdelijk en lees het in
temp_file <- tempfile(fileext = ".xlsx")
download.file(url_coverage, destfile = temp_file, mode = "wb")
df <- read_excel(temp_file)

#load data on child deaths directly from Dropbox (public direct link)
url_childdeath <- "https://www.dropbox.com/scl/fi/wuopfxxyux4dccc9rbibn/child-death.csv?rlkey=mfqw1b76522vtjqxcz7grvtmb&st=v0q288at&dl=1"

# Read the CSV into a dataframe
raw_healthspending_data <- read.csv(url_spending)

# Read the CSV into a dataframe
raw_childdeath_data <- read.csv(url_childdeath)


# Preview the first few rows to check the import
head(raw_healthspending_data)
head(df)

## 2.2 Provide a short summary of the dataset(s)
```
```{r}
head(raw_healthspending_data)
head(df)
```

In this case we see 28 variables, but we miss some information on what units they are in. We also don't know anything about the year/moment in which this data has been captured.

``` r
inline_code = TRUE
```

These are things that are usually included in the metadata of the dataset. For your project, you need to provide us with the information from your metadata that we need to understand your dataset of choice.

## 2.3 Describe the type of variables included

Think of things like:

-   Do the variables contain health information or SES information?

-   Have they been measured by interviewing individuals or is the data coming from administrative sources?

*For the sake of this example, I will continue with the assignment...*

# Part 3 - Quantifying

## 3.1 Data cleaning

Say we want to include only larger distances (above 2) in our dataset, we can filter for this.
```{r}
# Load and select relevant columns from raw data on health spending
cleaned_healthspending_data <- raw_healthspending_data %>%
  select(Region = Location, Year = Period, Spending = Value)

#  Ensure Year and Spending are numeric for health spending
cleaned_healthspending_data <- cleaned_healthspending_data %>%
  mutate(
    Year = as.numeric(Year),
    Spending = as.numeric(Spending)
  )

# Filter only WUENIC data from WHO regions and select relevant columns from the immunization dataset:
cleaned_dtpdata <- df %>%
  filter(
    COVERAGE_CATEGORY == "WUENIC",
    GROUP == "WHO_REGIONS"
  ) %>%
  select(Region = NAME, Year = YEAR, Coverage = COVERAGE)

# Ensure Year and Coverage are numeric, and create grouped time periods:
cleaned_dtpdata <- cleaned_dtpdata %>%
  mutate(
    Year = as.numeric(Year),
    Coverage = as.numeric(Coverage),
    PeriodGroup = case_when(
      Year >= 2000 & Year <= 2004 ~ "2000–2004",
      Year >= 2005 & Year <= 2009 ~ "2005–2009",
      Year >= 2010 & Year <= 2014 ~ "2010–2014",
      Year >= 2015 & Year <= 2019 ~ "2015–2019",
      Year >= 2020 & Year <= 2022 ~ "2020–2022"
    )
  )
```

```{r}
# Select and rename relevant columns from child death data
childdeath_selected <- raw_childdeath_data %>%
  select(Region = Location, Year = Period, Deaths = FactValueNumeric)

# Step 2: Ensure Year and Deaths are numeric
childdeath_typed <- childdeath_selected %>%
  mutate(
    Year = as.numeric(Year),
    Deaths = as.numeric(Deaths)
  )
```

Please use a separate 'R block' of code for each type of cleaning. So, e.g. one for missing values, a new one for removing unnecessary variables etc.

## 3.2 Generate necessary variables

```{r}
# Create period variable to group years
healthspending_with_period <- cleaned_healthspending_data %>%
  mutate(Period = case_when(
    Year >= 2000 & Year <= 2004 ~ "2000–2004",
    Year >= 2005 & Year <= 2009 ~ "2005–2009",
    Year >= 2010 & Year <= 2014 ~ "2010–2014",
    Year >= 2015 & Year <= 2019 ~ "2015–2019",
    Year >= 2020 & Year <= 2022 ~ "2020–2022",
    TRUE ~ NA_character_
  ))

# Summarize to calculate average spending per region and period
avg_healthspending_by_period <- healthspending_with_period %>% 
filter(!is.na(Period)) %>%
  group_by(Region, Period) %>%
  summarise(
    AvgSpending = mean(Spending, na.rm = TRUE),
    .groups = "drop"
  )

# Summarize to calculate average coverage per region and period:
DTPcoverage <- cleaned_dtpdata %>%
  filter(!is.na(PeriodGroup)) %>%
  group_by(Region, PeriodGroup) %>%
  summarise(
    AvgCoverage = mean(Coverage, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(Region)
# Create period variable
childdeath_with_period <- childdeath_typed %>%
  mutate(Period = case_when(
    Year >= 2000 & Year <= 2004 ~ "2000–2004",
    Year >= 2005 & Year <= 2009 ~ "2005–2009",
    Year >= 2010 & Year <= 2014 ~ "2010–2014",
    Year >= 2015 & Year <= 2019 ~ "2015–2019",
    Year >= 2020 & Year <= 2022 ~ "2020–2022",
    TRUE ~ NA_character_
  ))
```

```{r}
# Step Summarise average child deaths per region and period
avg_childdeath_by_period <- childdeath_with_period %>%
filter(!is.na(Period)) %>%
  group_by(Region, Period) %>%
  summarise(
    AvgChildDeath = mean(Deaths, na.rm = TRUE),
    .groups = "drop"
  )
```  
  
  
# 3.25 merge datasets together 
```{r}  
# Recode WHO region codes to match full region names used in other datasets
DTPcoverage <- DTPcoverage %>%
  mutate(
    Region = recode(Region,
      "African Region" = "Africa",
      "Eastern Mediterranean Region" = "Eastern Mediterranean",
      "European Region" = "Europe",
      "Region of the Americas" = "Americas",
      "South-East Asia Region" = "South-East Asia",
      "Western Pacific Region" = "Western Pacific"
    )
  )

 # First, make sure Period column exists in DTPcoverage instead of PeriodGroup
DTPcoverage <- DTPcoverage %>%
  rename(Period = PeriodGroup)
```

```{r}
# Merge all three datasets by Region and Period
merged_health_data <- avg_healthspending_by_period %>%
  inner_join(DTPcoverage, by = c("Region", "Period")) %>%
  inner_join(avg_childdeath_by_period, by = c("Region", "Period"))

# Add constructed variables
merged_health_data <- merged_health_data %>%
  mutate(
    CoveragePerDollar = AvgCoverage / AvgSpending,
    DollarPerCoveragePoint = AvgSpending / AvgCoverage,
    DeathsPerSpending = AvgChildDeath / AvgSpending
  )

# View final merged dataframe
print(merged_health_data)
class(merged_health_data)

# change the merged data from a tibble to a dataframe
merged_healthdata_df <- as.data.frame(merged_health_data)
```

## 3.3 Visualize temporal variation

```{r}
library(ggplot2)
library(hrbrthemes)

ggplot(merged_healthdata_df, aes(x = AvgSpending, y = AvgCoverage)) +
  geom_point( size = 3) +
  geom_smooth(method=lm , color="red", se=FALSE) +
  labs( 
    title = "The average linear relationship between HS and VC over a period of 5 years", x = "Average Health Spending (USD per Capita)", y = "Average Vaccination Coverage (%)"
        ) 

ggplot(merged_healthdata_df, aes(x = AvgChildDeath, y = AvgCoverage)) +
  geom_point( size = 3) +
  geom_smooth(method=lm , color="magenta", se=FALSE) +
  labs( 
    title = "The average linear relationship between CD and VC over a period of 5 years", x = "Average Child Death", y = "Average Vaccination Coverage (%)"
        ) 

#vaccinatiegraad vergelijken met childdeath & vaccinatiegraad vergelijken met healthspending. Normale lijngrafieken.
```
# with linear trend
p2 <- ggplot(data, aes(x=my_x, y=my_y)) +
  geom_point() +
  geom_smooth(method=lm , color="red", se=FALSE) +
  theme_ipsum()

## 3.4 Visualize spatial variation

```{r visualise_map}
install.packages("rnaturalearth")
install.packages("rnaturalearthdata")
install.packages("sf")
install.packages("dplyr")
install.packages("ggplot2")
install.packages("viridis")
install.packages("grid")

library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(dplyr)
library(ggplot2)
library(viridis)
library(grid)

# Wereld shapefile laden
world <- ne_countries(scale = "medium", returnclass = "sf")

# WHO-regio vaccinatiecijfers
who_region_vaccination <- data.frame(
  WHORegion = c("Africa", "Americas", "Europe", "Eastern Mediterranean", "South-East Asia", "Western Pacific"),
  VaccinationRate = c(72, 89, 94, 85, 91, 88)
)

# WHO-regio's per land (vereenvoudigde mapping)
# In praktijk zou je dit uit een officiële WHO-tabel halen
world <- world %>%
  mutate(
  WHORegion = case_when(
    world$region_wb == "Sub-Saharan Africa" ~ "Africa",
    world$region_wb == "Latin America & Caribbean" ~ "Americas",
    world$region_wb == "Europe & Central Asia" ~ "Europe",
    world$region_wb == "Middle East & North Africa" ~ "Eastern Mediterranean",
    world$region_wb == "South Asia" ~ "South-East Asia",
    world$region_wb == "East Asia & Pacific" ~ "Western Pacific",
    TRUE ~ NA_character_
  )
)

# Voeg vaccinatiecijfers toe
world <- left_join(world, who_region_vaccination, by = "WHORegion")

# Plot choropleth map
ggplot(world) +
  geom_sf(aes(fill = VaccinationRate), color = "white", size = 0.2) +
  scale_fill_viridis_c(
    na.value = "gray90",
    trans = "log",
    name = "Vaccination Grade (%)",
    breaks = c(50, 60, 70, 80, 90),
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(12, units = "mm"),
      label.position = "bottom",
      title.position = "top",
      nrow = 1
    )
  ) +
  labs(
    title = "Vaccination coverage concentration",
    subtitle = "Vaccination grade per WHO region (aggregated to countries)",
    caption = "Source: WHO Region Aggregates"
  ) +
  theme_void() +
  theme(
    text = element_text(color = "#22211d"),
    plot.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.background = element_rect(fill = "#f5f5f2", color = NA),
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    plot.title = element_text(size = 20, hjust = 0.01, color = "#4e4d47"),
    plot.subtitle = element_text(size = 15, hjust = 0.01, color = "#4e4d47"),
    plot.caption = element_text(size = 10, color = "#4e4d47"),
    legend.position = "bottom"
  )
```

## 3.5 Visualize sub-population variation

```{r visualise_map}
# continenten indelen op healthspending per capita om vervolgens te vergelijken in vaccinatiegraad en childdeath.

```

What is the poverty rate by state?


library(ggplot2)
data("midwest")

midwest$inmetro <- midwest$inmetro %>% as.factor()
# Boxplot of poverty rate by state using the 'midwest' dataset
ggplot(midwest, aes(x = inmetro, y = percadultpoverty)) +
  geom_boxplot() +
  labs(
    title = "Distribution of Poverty Rates by Metropolitan status (Midwest counties)",
    x = "Metropolitan Area",
    y = "Poverty Rate of Adults (%)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right"
  )
```

Here you provide a description of why the plot above is relevant to your specific social problem.

## 3.6 Event analysis

Analyze the relationship between two variables.





Here you provide a description of why the plot above is relevant to your specific social problem.

# Part 4 - Discussion

## 4.1 Discuss your findings

# Part 5 - Reproducibility

## 5.1 Github repository link

Provide the link to your PUBLIC repository here: ...

## 5.2 Reference list

Use APA referencing throughout your document.
